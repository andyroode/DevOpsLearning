include:
  - project: IT.DPL.auto-deployment/pipelined/dp_build
    ref: v0.13.0
    file: templates/api.yaml
####################################
#### module variables (IT.DPL.auto-deployment/pipelined/dp_build)
.dp_build.variables:
  variables:
    PREVIOUS_VERSION: 'init'
    NEW_VERSION: "${CI_COMMIT_REF_NAME}"
    dp_new_naming: "None"
    #### From gitlab secrets variables:
    # CISRVRECN_PASSWORD
    # CISRVRECN_USER
    # PATI_USER
    # PATI_PASSWORD


.build:
  cache: {}
  rules:
    - if: $CI_COMMIT_TAG =~ /^.*\d+\.\d+\.\d+/
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /\[ci_build_parameters]/
      when: never
    - if: $CI_COMMIT_REF_NAME =~ /^release/
    - if: $CI_COMMIT_REF_NAME =~ /^feature/
    - if: $CI_COMMIT_REF_NAME =~ /^bugfix/
    - if: $CI_COMMIT_REF_NAME =~ /^evergreen/
    - if: $CI_COMMIT_REF_NAME =~ /master/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
  variables:
    release_mode: 'false'

.build_promote:
  cache: {}
  rules:
    - if: $CI_COMMIT_TAG =~ /^.*\d+\.\d+\.\d+/

build_and_commit_parameters_containers:
  extends:
    - .build_and_commit_parameters_containers
    - .build
  stage: prefix_build

dp_build:
  dependencies:
    - build_and_commit_parameters_containers
  extends:
    - .dp_build.build
    - .build
  stage: dp_build_repo
  variables:
    dp_package_type: "Microservice"
    dp_parameters_file: "${CI_PROJECT_DIR}/description_template.yaml"

dp_build_promote:
  dependencies:
    - build_and_commit_parameters_containers
  extends:
    - .dp_build.build_and_promote_microservice
    - .build_promote
  stage: dp_build_promote
  variables:
    dp_package_type: "Microservice"
    dp_parameters_file: "${CI_PROJECT_DIR}/description_template.yaml"
  artifacts:
    paths:
      - ./archive.yaml
      - ./GAV_coordinates.yaml