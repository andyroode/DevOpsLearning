name: Build and Archive Templates

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  prefix_build:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ct_skip]')" # Аналог rules
    container:
      image: ghcr.io/netcracker/qubership-build-envgene:main
      options: --entrypoint /bin/bash
    env:
      module_ansible_dir: /module/ansible
      module_inventory: ${{ github.workspace }}/configuration/inventory.yaml
      module_ansible_cfg: /module/ansible/ansible.cfg
      module_config_default: /module/templates/defaults.yaml
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Build Parameters Containers
        run: python3 /build_env/scripts/build_env/parameter_container_handler.py

      - name: Prepare Git Commit
        run: /module/scripts/prepare.sh "/module/ansible/playbooks/git_commit.yaml"

      - name: Create Archive
        run: |
          mkdir -p archives # Создаем директорию для архива
          zip -r archives/generated_templates.zip templates # Упаковываем templates в архив

      - name: Upload Archive
        uses: actions/upload-artifact@v3
        with:
          name: generated-templates
          path: archives/generated_templates.zip
