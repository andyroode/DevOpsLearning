name: Build and Archive Templates

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  prefix_build:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ct_skip]')" # Аналог rules
    container:
      image: ghcr.io/netcracker/qubership-build-envgene:main
      options: --entrypoint /bin/bash
    env:
      module_ansible_dir: /module/ansible
      module_inventory: ${{ github.workspace }}/configuration/inventory.yaml
      module_ansible_cfg: /module/ansible/ansible.cfg
      module_config_default: /module/templates/defaults.yaml
      CI_PROJECT_DIR: ${{ github.workspace }}
      CI_SERVER_HOST: github.com
      CI_PROJECT_PATH: ${{ github.repository }}
      CI_COMMIT_REF_NAME: ${{ github.ref_name }}
      GITLAB_USER_EMAIL: ${{ secrets.GITLAB_USER_EMAIL }}
      GITLAB_USER_LOGIN: ${{ secrets.GITLAB_USER_LOGIN }}
      GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      ENV_NAME: my_environment
      CLUSTER_NAME: my_cluster
      ENVIRONMENT_NAME: my_environment_name
      DEPLOYMENT_TICKET_ID: ticket_12345
      COMMIT_ENV: production
      COMMIT_MESSAGE: "Automated commit [ci_skip]"
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build Parameters Containers
        run: python3 /build_env/scripts/build_env/parameter_container_handler.py

      - name: Prepare Git Commit
        run: /module/scripts/prepare.sh "git_commit.yaml"

      - name: Create Archive
        run: |
          mkdir -p archives 
          zip -r archives/generated_templates.zip templates

      - name: Upload Archive
        uses: actions/upload-artifact@v3
        with:
          name: generated-templates
          path: archives/generated_templates.zip
